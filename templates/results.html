{% extends 'header.html' %}
{% block content %}
<link rel="stylesheet" href="../static/style.css"
      xmlns="http://www.w3.org/1999/html">
<body>
    <div class="rectangle_container">
        <h2>Select a chromosome below:</h2>
        <form action="{{ url_for('select_chromosome') }}" method="POST">
            <div class="btn-group">
                <input type="hidden" name="JSON_dict" value="{{ JSON_dict }}">
                <input type="hidden" name="disable_button_dict" value="{{ disable_button_dict }}">
                {% for i in range(1, 23) %}
                    <button id="{{ i }}" class="grow" name="chromosome_button" value="{{ i }}" type="submit">{{ i }}</button>
                {% endfor %}
                <button id="X" class="grow" name="chromosome_button" value="X" type="submit">X</button>&nbsp;
                <button id="Y" class="grow" name="chromosome_button" value="Y" type="submit">Y</button>&nbsp;
                <button id="MT" class="grow" name="chromosome_button" value="MT" type="submit">MT</button>
            </div>
            <br>
        </form>
        <button id="results_per_chromosome_button" class="btn btn-lg btn-primary"
                onclick="results_per_chromosome()">
            Click for more information per chromosome
        </button>
        <br><br>

       <table id="results_per_chromosome" class="results_table border border-3 rounded" style="display: none">
            <tr>
                <th>Chromosome</th>
                {% for i in range(1, 23) %}
                    <td class="results_table_chromosomes">{{ i }}</td>
                {% endfor %}
                <td class="results_table_chromosomes">X</td>
                <td class="results_table_chromosomes">Y</td>
                <td class="results_table_chromosomes">MT</td>
                <td class="results_table_chromosomes">Total</td>
            </tr>
            <tr>
                <th>Total variants</th>
                {% set count_variants = namespace(value=0) %}
                {% for i in results_table_dict %}
                    {% set count_variants.value = count_variants.value + results_table_dict[i][0] %}
                    <td>{{ results_table_dict[i][0] }}</td>
                {% endfor %}
                <td>{{ count_variants.value }}</td>
            </tr>
            <tr>
                <th>Benign</th>
                {% set count_benign = namespace(value=0) %}
                {% for i in results_table_dict %}
                    {% set count_benign.value = count_benign.value + results_table_dict[i][1] %}
                    <td>{{ results_table_dict[i][1] }}</td>
                {% endfor %}
                <td>{{ count_benign.value }}</td>
            </tr>
            <tr>
                <th>Likely benign</th>
                {% set count_likely_benign = namespace(value=0) %}
                {% for i in results_table_dict %}
                    {% set count_likely_benign.value = count_likely_benign.value + results_table_dict[i][2] %}
                    <td>{{ results_table_dict[i][2] }}</td>
                {% endfor %}
                <td>{{ count_likely_benign.value }}</td>
            </tr>
            <tr>
                <th>Likely pathogenic</th>
                {% set count_likely_pathogenic = namespace(value=0) %}
                {% for i in results_table_dict %}
                    {% set count_likely_pathogenic.value = count_likely_pathogenic.value + results_table_dict[i][3] %}
                    <td>{{ results_table_dict[i][3] }}</td>
                {% endfor %}
                <td>{{ count_likely_pathogenic.value }}</td>
            </tr>
            <tr>
                <th>Pathogenic</th>
                {% set count_pathogenic = namespace(value=0) %}
                {% for i in results_table_dict %}
                    {% set count_pathogenic.value = count_pathogenic.value + results_table_dict[i][4] %}
                    <td>{{ results_table_dict[i][4] }}</td>
                {% endfor %}
                <td>{{ count_pathogenic.value }}</td>
            </tr>
            <tr>
                <th>Predicted benign</th>
                {% set count_predicted_benign = namespace(value=0) %}
                {% for i in results_table_dict %}
                    {% set count_predicted_benign.value = count_predicted_benign.value + results_table_dict[i][5] %}
                    <td>{{ results_table_dict[i][5] }}</td>
                {% endfor %}
                <td>{{ count_predicted_benign.value }}</td>
            </tr>
            <tr>
                <th>Predicted pathogenic</th>
                {% set count_predicted_pathogenic = namespace(value=0) %}
                {% for i in results_table_dict %}
                    {% set count_predicted_pathogenic.value = count_predicted_pathogenic.value + results_table_dict[i][6] %}
                    <td>{{ results_table_dict[i][6] }}</td>
                {% endfor %}
                <td>{{ count_predicted_pathogenic.value }}</td>
            </tr>
        </table>
        <script>
            function results_per_chromosome() {
                var x = document.getElementById("results_per_chromosome");
                if (x.style.display === "none") {
                    x.style.display = "block";
                } else {
                    x.style.display = "none";
                }
            }
        </script>
        <br>
        <div class="rectangle_visualisation">
            <h2 id='selected_chromosome'>Please select a chromosome above to
                start.</h2>
            <div id='chart' class='chart'></div>
            <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
            <script>
                document.getElementById("selected_chromosome").innerHTML = "Currently showing chromosome " + "{{ selected_chrom }}" + ":";
                var graph = {{ JSON_graph | safe }};
                Plotly.plot('chart', graph, {});
            </script>

            <div id="results_textbox"></div>

            <script>
                var myPlot = document.getElementById('chart')
                myPlot.on('plotly_click', function (graph) {
                    var chrom = "{{ selected_chrom }}"
                    var pos = graph.points[0].x.toString()
                    var ref = graph.points[0].customdata[0]
                    var alt = graph.points[0].customdata[1]
                    var results = {{ results | tojson }}
                    console.log(graph)
                    var text = ""
                    results.forEach(checkResult)

                    function checkResult(result_dict) {
                        if (result_dict["CHROM"] === chrom &&
                            result_dict["POS"] === pos &&
                            result_dict["REF"] === ref &&
                            result_dict["ALT"] === alt) {
                            if (result_dict["ML prediction"] === 0){
                                result_dict["ML prediction"] = 'benign'
                            }else{
                                result_dict["ML prediction"] = 'pathogenic'
                            }

                            text = "<h2>Chromosome information</h2>" +
                                "<br><b>Chromosome:</b> " + result_dict["CHROM"] +
                                "<br><b>Position:</b> " + result_dict["POS"] +
                                "<br><b>REF:</b> " + result_dict["REF"] +
                                "<br><b>ALT:</b> " + result_dict["ALT"] +
                                "<br><b>AF_ESP:</b> " + result_dict["AF_ESP"] +
                                "<br><b>AF_EXAC:</b> " + result_dict["AF_EXAC"] +
                                "<br><b>AF_TGP:</b> " + result_dict["AF_TGP"] +
                                "<br><b>ALLELEID:</b> " + result_dict["ALLELEID"] +
                                "<br><b>CLNDN:</b> " + result_dict["CLNDN"] +
                                "<br><b>CLNDISDB:</b> " + result_dict["CLNDISDB"] +
                                "<br><b>CLNREVSTAT:</b> " + result_dict["CLNREVSTAT"] +
                                "<br><b>CLNSIG:</b> " + result_dict["CLNSIG"] +
                                "<br><b>CLNVC:</b> " + result_dict["CLNVC"] +
                                "<br><b>GENEINFO:</b> " + result_dict["GENEINFO"] +
                                "<br><b>MC:</b> " + result_dict["MC"] +
                                "<br><b>RS:</b> " + result_dict["RS"] +
                                "<br><b>REF LENGTH:</b> " + result_dict["REF LENGTH"] +
                                "<br><b>ALT LENGTH:</b> " + result_dict["ALT LENGTH"] +
                                "<br><b>ML prediction:</b> " + result_dict["ML prediction"]
                                if (parseFloat(result_dict["Probability 0"]) >= parseFloat(result_dict["Probability 1"])){
                                    text += "<br><b>Probability benign:</b> " + result_dict["Probability 0"]
                                } else{
                                    text += "<br><b>Probability pathogenic:</b> " + result_dict["Probability 1"]
                                }


                            document.getElementById("results_textbox").innerHTML = text
                        }
                    }
                });
            </script>
        </div>
    </div><br>

    {% for key in disable_button_dict.keys() %}
    {% if disable_button_dict[key] == True %}
    <script>
        document.getElementById("{{ key }}").disabled = true;
        document.getElementById("{{ key }}").style.backgroundColor = "grey";
        document.getElementById("{{ key }}").style.borderColor = "grey";
    </script>
    {% endif %}
    {% endfor %}
</body>
{% endblock %}